<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemeinde Konkordia - Veranstaltungen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #000;
            overflow: hidden;
            color: #fff;
        }

        #slideshow {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .slide {
            display: none;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .slide.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        #controls.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #controls:hover {
            opacity: 1 !important;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        button {
            background: #bb2232;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #d62839;
        }

        button:active {
            transform: scale(0.95);
        }

        #progress-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #bb2232;
            width: 0%;
            transition: width 0.1s linear;
            z-index: 999;
        }

        #slide-counter {
            font-size: 18px;
            font-weight: bold;
        }

        #play-pause-icon {
            font-size: 20px;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }

        /* Fullscreen Toggle */
        #fullscreen-btn {
            background: #555;
        }

        #fullscreen-btn:hover {
            background: #777;
        }

        /* Keyboard Shortcuts Info */
        #shortcuts {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            display: none;
        }

        #shortcuts.visible {
            display: block;
        }

        #shortcuts h3 {
            margin-bottom: 15px;
            color: #bb2232;
        }

        #shortcuts ul {
            list-style: none;
        }

        #shortcuts li {
            margin: 8px 0;
            font-size: 14px;
        }

        #shortcuts kbd {
            background: #333;
            padding: 3px 8px;
            border-radius: 3px;
            margin-right: 10px;
            font-family: monospace;
        }

        /* Auto-hide cursor after inactivity */
        body.hide-cursor {
            cursor: none;
        }

        body.hide-cursor #controls {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="loading">Lade Folien...</div>

    <div id="slideshow"></div>

    <div id="progress-bar"></div>

    <div id="controls">
        <div class="control-group">
            <button id="prev-btn" title="Vorherige Folie (Pfeil Links)">◀ Zurück</button>
            <button id="play-pause-btn" title="Pause/Play (Leertaste)">
                <span id="play-pause-icon">⏸</span>
            </button>
            <button id="next-btn" title="Nächste Folie (Pfeil Rechts)">Weiter ▶</button>
        </div>

        <div class="control-group">
            <span id="slide-counter">0 / 0</span>
            <button id="fullscreen-btn" title="Vollbild (F)">⛶ Vollbild</button>
            <button id="help-btn" title="Tastatur-Shortcuts (H)">? Hilfe</button>
        </div>
    </div>

    <div id="shortcuts">
        <h3>Tastatur-Shortcuts</h3>
        <ul>
            <li><kbd>←</kbd> Vorherige Folie</li>
            <li><kbd>→</kbd> Nächste Folie</li>
            <li><kbd>Leertaste</kbd> Pause/Play</li>
            <li><kbd>F</kbd> Vollbild</li>
            <li><kbd>ESC</kbd> Vollbild beenden</li>
            <li><kbd>H</kbd> Hilfe ein/aus</li>
            <li><kbd>R</kbd> Neu laden</li>
        </ul>
    </div>

    <script>
        // Konfiguration
        const CONFIG = {
            TERMIN_DURATION: 10000,   // 10 Sekunden für Termine
            INFO_DURATION: 6000,      // 6 Sekunden für Info-Folien
            AUTO_HIDE_CURSOR: 3000,   // Cursor nach 3s ausblenden
        };

        // State
        let slides = [];
        let currentSlide = 0;
        let isPlaying = true;
        let autoPlayTimer = null;
        let progressInterval = null;
        let cursorTimeout = null;
        let progressStartTime = 0;

        // Elements
        const slideshowEl = document.getElementById('slideshow');
        const loadingEl = document.getElementById('loading');
        const controlsEl = document.getElementById('controls');
        const progressBarEl = document.getElementById('progress-bar');
        const slideCounterEl = document.getElementById('slide-counter');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const helpBtn = document.getElementById('help-btn');
        const shortcutsEl = document.getElementById('shortcuts');

        // Load slides
        async function loadSlides() {
            try {
                // Lade alle PNG-Folien aus dem slides/ Ordner
                const response = await fetch('slides/');
                const html = await response.text();

                // Parse HTML und finde alle .png Dateien
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('a');

                const slideFiles = [];
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.endsWith('.png') && href.startsWith('slide_')) {
                        slideFiles.push(href);
                    }
                });

                // Sortiere Folien
                slideFiles.sort();

                // Erstelle Slide-Objekte
                slides = slideFiles.map(file => ({
                    src: `slides/${file}`,
                    isInfo: file.includes('_info.png'),
                    duration: file.includes('_info.png') ? CONFIG.INFO_DURATION : CONFIG.TERMIN_DURATION
                }));

                // Falls keine Folien via Directory Listing gefunden, versuche direkt zu laden
                if (slides.length === 0) {
                    console.log('Keine Folien via Directory Listing gefunden, versuche direkte Suche...');
                    await loadSlidesDirectly();
                }

                if (slides.length === 0) {
                    throw new Error('Keine Folien gefunden!');
                }

                console.log(`${slides.length} Folien geladen`);
                createSlideElements();
                loadingEl.classList.add('hidden');
                showSlide(0);
                startAutoPlay();

            } catch (error) {
                console.error('Fehler beim Laden der Folien:', error);
                loadingEl.textContent = 'Fehler beim Laden der Folien. Bitte Seite neu laden.';

                // Fallback: Versuche direkte Suche
                await loadSlidesDirectly();
            }
        }

        // Fallback: Direkte Suche nach Folien (ohne Directory Listing)
        async function loadSlidesDirectly() {
            const maxSlides = 50;
            const foundSlides = [];

            for (let i = 0; i < maxSlides; i++) {
                const filename = `slide_${String(i).padStart(2, '0')}`;

                // Versuche PNG
                try {
                    const response = await fetch(`slides/${filename}_titel.png`, { method: 'HEAD' });
                    if (response.ok) {
                        foundSlides.push({
                            src: `slides/${filename}_titel.png`,
                            isInfo: false,
                            duration: CONFIG.TERMIN_DURATION
                        });
                        continue;
                    }
                } catch (e) {}

                // Versuche andere Patterns
                const patterns = ['_info.png', '.png'];
                for (const pattern of patterns) {
                    try {
                        const response = await fetch(`slides/${filename}${pattern}`, { method: 'HEAD' });
                        if (response.ok) {
                            foundSlides.push({
                                src: `slides/${filename}${pattern}`,
                                isInfo: pattern.includes('info'),
                                duration: pattern.includes('info') ? CONFIG.INFO_DURATION : CONFIG.TERMIN_DURATION
                            });
                            break;
                        }
                    } catch (e) {}
                }
            }

            if (foundSlides.length > 0) {
                slides = foundSlides;
                console.log(`${slides.length} Folien direkt geladen`);
                createSlideElements();
                loadingEl.classList.add('hidden');
                showSlide(0);
                startAutoPlay();
            }
        }

        // Erstelle Slide-Elemente
        function createSlideElements() {
            slideshowEl.innerHTML = '';

            slides.forEach((slide, index) => {
                const img = document.createElement('img');
                img.src = slide.src;
                img.alt = `Folie ${index + 1}`;
                img.className = 'slide';
                img.dataset.index = index;
                slideshowEl.appendChild(img);
            });

            updateCounter();
        }

        // Zeige Folie
        function showSlide(index) {
            const slideElements = document.querySelectorAll('.slide');
            slideElements.forEach(el => el.classList.remove('active'));

            currentSlide = (index + slides.length) % slides.length;
            slideElements[currentSlide]?.classList.add('active');

            updateCounter();
            resetProgress();

            if (isPlaying) {
                scheduleNextSlide();
            }
        }

        // Auto-Play
        function startAutoPlay() {
            if (!isPlaying) return;
            scheduleNextSlide();
        }

        function scheduleNextSlide() {
            clearTimeout(autoPlayTimer);
            const duration = slides[currentSlide]?.duration || CONFIG.TERMIN_DURATION;

            progressStartTime = Date.now();
            startProgressBar(duration);

            autoPlayTimer = setTimeout(() => {
                nextSlide();
            }, duration);
        }

        function stopAutoPlay() {
            clearTimeout(autoPlayTimer);
            stopProgressBar();
        }

        // Progress Bar
        function startProgressBar(duration) {
            stopProgressBar();

            progressInterval = setInterval(() => {
                const elapsed = Date.now() - progressStartTime;
                const percent = Math.min((elapsed / duration) * 100, 100);
                progressBarEl.style.width = `${percent}%`;

                if (percent >= 100) {
                    stopProgressBar();
                }
            }, 50);
        }

        function stopProgressBar() {
            clearInterval(progressInterval);
        }

        function resetProgress() {
            progressBarEl.style.width = '0%';
        }

        // Navigation
        function nextSlide() {
            showSlide(currentSlide + 1);
        }

        function prevSlide() {
            showSlide(currentSlide - 1);
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            playPauseIcon.textContent = isPlaying ? '⏸' : '▶';

            if (isPlaying) {
                startAutoPlay();
            } else {
                stopAutoPlay();
            }
        }

        // Counter
        function updateCounter() {
            slideCounterEl.textContent = `${currentSlide + 1} / ${slides.length}`;
        }

        // Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Help
        function toggleHelp() {
            shortcutsEl.classList.toggle('visible');
        }

        // Cursor Auto-Hide
        function resetCursorTimeout() {
            document.body.classList.remove('hide-cursor');
            clearTimeout(cursorTimeout);

            cursorTimeout = setTimeout(() => {
                document.body.classList.add('hide-cursor');
            }, CONFIG.AUTO_HIDE_CURSOR);
        }

        // Event Listeners
        prevBtn.addEventListener('click', prevSlide);
        nextBtn.addEventListener('click', nextSlide);
        playPauseBtn.addEventListener('click', togglePlayPause);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        helpBtn.addEventListener('click', toggleHelp);

        // Keyboard
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                    prevSlide();
                    break;
                case 'ArrowRight':
                    nextSlide();
                    break;
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'f':
                case 'F':
                    toggleFullscreen();
                    break;
                case 'Escape':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    if (shortcutsEl.classList.contains('visible')) {
                        toggleHelp();
                    }
                    break;
                case 'h':
                case 'H':
                    toggleHelp();
                    break;
                case 'r':
                case 'R':
                    location.reload();
                    break;
            }
        });

        // Mouse Move
        document.addEventListener('mousemove', resetCursorTimeout);
        document.addEventListener('click', resetCursorTimeout);

        // Initial cursor timeout
        resetCursorTimeout();

        // Start
        loadSlides();
    </script>
</body>
</html>
